{% extends 'base.html' %}
{% block content %}
<div class="container">
    <form id='propiedad' action="confirm" method="post">
        {% csrf_token %}
        <table>
            <tr>
                <td>
                    <label for='titulo'>Titulo de la Publicacion:</label>
                </td>
                <td>
                    <input type="text" name="titulo" />
                </td>
            </tr>
            <tr>
                <td>
                    <label for='descripcion'>Descripcion:</label>
                </td>
                <td>
                    <input type="text" name="descripcion" />
                </td>
            </tr>
            <tr>
                <td>
                    <label for='direccion.calle'>Calle:</label>
                </td>
                <td>
                    <input type="text" name="direccion.calle" list='calles' />
                    <datalist id='calles'></datalist>
                </td>
                <td>
                    <label for='direccion.numero'>#</label>
                </td>
                <td>
                    <input type="text" name="direccion.numero" />
                </td>
            </tr>
            <tr class="col-xs-12 col-sm-8 col-md-6 col-lg-4">
                <td>
                    <label for='direccion.piso'>Piso</label>
                </td>
                <td>
                    <input type="text" name="direccion.piso" />
                </td>
                <td>
                    <label for='direccion.dpto'>Departamento</label>
                </td>
                <td>
                    <input type="text" name="direccion.dpto" />
                </td>
            </tr>
            <tr class="col-xs-12 col-sm-8 col-md-6 col-lg-4">
                <td>
                    <label for='direccion.pais'>Pais:</label>
                </td>
                <td>
                    <select id='pais' name="direccion.pais" style="width: 100%;"></select>
                </td>
                <td>
                    <label for='direccion.provincia'>Provincia/Estado:</label>
                </td>
                <td>
                    <select id='provincia' name="direccion.provincia" style="width: 100%;"></select>
                </td>
                <td>
                    <label for='direccion.localidad'>Localidad:</label>
                </td>
                <td>
                    <select id='localidad' name="direccion.localidad" style="width: 100%;"></select>
                </td>
            </tr>
            <tr class="col-xs-12 col-sm-8 col-md-6 col-lg-4">
                <td>
                    <input type='submit' value='Enviar' />
                </td>
            </tr>
        </table>
    </form>
</div>
<script>
    /* window.params = {
        titulo: '',
        descripcion: '',
        direccion: {
            calle: 0,
            numero: 0,
            localidad: 0,
        }
    } */

    function fillCombo(id, data) {
        var options = data.map(
                function(d) {
                    return `<option value=${d.id}>${d.nombre}</option>`;
                }
            );
        var select = $(`${id}`);
        select.children().remove();
        select.append(options);
    }

    function fetchPaises() {
        $.ajax({
            url: `/data/geo/`,
            dataType: 'json'
        }).done(
            function(data) {
                if (data.length > 0) {
                    fillCombo('#pais', data);
                    fetchProvincias(data[0].id);
                }
            }
        );
    }

    function fetchProvincias(pais) {
        $.ajax({
            url: `/data/geo/pais/${pais}`,
            dataType: 'json'
        }).done(
            function(data) {
                if (data.length > 0) {
                    fillCombo('#provincia', data);
                    fetchLocalidades(data[0].id);
                }
            }
        );
    }

    function fetchLocalidades(prov) {
        $.ajax({
            url: `/data/geo/provincia/${prov}`,
            dataType: 'json'
        }).done(
            function(data) {
                if (data.length > 0) {
                    fillCombo('#localidad', data);
                    fetchCalles(data[0].id);
                }
            }
        );
    }

    function fetchCalles(loc) {
        $.ajax({
            url: `/data/geo/localidad/${loc}`,
            dataType: 'json'
        }).done(
            function(data) {
                if (data.length > 0) {
                    fillCombo('#calles', data);
                }
            }
        )
    }

    function paisOnChange(e) { fetchProvincias(e.target.value); }
    function provinciaOnChange(e) { fetchLocalidades(e.target.value); }
    function localidadOnChange(e) { fetchCalles(e.target.value); }
/*     function localidadOnChange(e) { window.params.direccion.localidad = e.target.value }
    function calleOnChange(e) { window.params.direccion.calle = e.targe.value } */
    
    $('#pais').on('change', paisOnChange);
    $('#provincia').on('change', provinciaOnChange);
    fetchPaises();
    /* $('#propiedad').on('submit',
        function(e) {
            e.preventDefault();
            var data = {};
            console.log($(this));
        }); */

</script>
{% endblock %}